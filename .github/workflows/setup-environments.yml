name: Setup GitHub Environments

on:
  workflow_dispatch:
    inputs:
      update_domains:
        description: 'Update environment domains'
        required: false
        default: false
        type: boolean

jobs:
  setup-environments:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      administration: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Production Environment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            try {
              // Create or update production environment
              await github.rest.repos.createOrUpdateEnvironment({
                owner,
                repo,
                environment_name: 'prod',
                wait_timer: 0,
                reviewers: [],
                deployment_branch_policy: {
                  protected_branches: true,
                  custom_branch_policies: false
                }
              });
              
              console.log('âœ… Production environment created/updated');
            } catch (error) {
              console.log('âŒ Failed to create production environment:', error.message);
            }

      - name: Setup Beta Environment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            try {
              // Create or update beta environment
              await github.rest.repos.createOrUpdateEnvironment({
                owner,
                repo,
                environment_name: 'beta',
                wait_timer: 0,
                reviewers: [],
                deployment_branch_policy: {
                  protected_branches: false,
                  custom_branch_policies: true,
                  custom_branches: ['dev']
                }
              });
              
              console.log('âœ… Beta environment created/updated');
            } catch (error) {
              console.log('âŒ Failed to create beta environment:', error.message);
            }

      - name: Setup Development Environment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            try {
              // Create or update development environment
              await github.rest.repos.createOrUpdateEnvironment({
                owner,
                repo,
                environment_name: 'dev',
                wait_timer: 0,
                reviewers: [],
                deployment_branch_policy: {
                  protected_branches: false,
                  custom_branch_policies: false
                }
              });
              
              console.log('âœ… Development environment created/updated');
            } catch (error) {
              console.log('âŒ Failed to create development environment:', error.message);
            }

      - name: Environment Setup Summary
        run: |
          echo "## GitHub Environments Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following environments have been configured:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŸ¢ Production (\`prod\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://coregame.de" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main (protected branches only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŸ¡ Beta/Staging (\`beta\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://beta.coregame.de" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”µ Development (\`dev\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://dev.coregame.de" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** any feature branch" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Update the domain URLs in the values files" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure Kubernetes cluster secrets" >> $GITHUB_STEP_SUMMARY
          echo "3. Test deployments with manual workflow runs" >> $GITHUB_STEP_SUMMARY 