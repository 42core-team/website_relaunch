name: Test Kubernetes Connection

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.4'

      - name: Test Kubernetes Authentication
        run: |
          echo "ğŸ” Testing Kubernetes connection..."
          echo ""
          
          # Check if KUBECONFIG_DATA secret is set
          if [ -z "${{ secrets.KUBECONFIG_DATA }}" ]; then
            echo "âŒ KUBECONFIG_DATA secret is not configured!"
            echo ""
            echo "ğŸ“‹ To fix this:"
            echo "1. Run: cat ~/.kube/config | base64 -w 0"
            echo "2. Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "3. Add secret named 'KUBECONFIG_DATA' with the base64 output"
            echo ""
            exit 1
          fi
          
          echo "âœ… KUBECONFIG_DATA secret is configured"
          
          # Create .kube directory and decode kubeconfig
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Verify kubeconfig was decoded properly
          if [ ! -s ~/.kube/config ]; then
            echo "âŒ Kubeconfig file is empty after decoding!"
            echo "Please verify that KUBECONFIG_DATA contains valid base64 encoded kubeconfig"
            exit 1
          fi
          
          echo "âœ… Kubeconfig decoded successfully"
          
          # Test cluster connection
          echo ""
          echo "ğŸ”— Testing cluster connection..."
          kubectl cluster-info
          
          echo ""
          echo "ğŸ“Š Cluster nodes:"
          kubectl get nodes
          
          echo ""
          echo "ğŸ“¦ Checking namespaces:"
          kubectl get namespaces | grep -E "(production|staging|development)" || echo "No deployment namespaces found (this is normal for first setup)"
          
          echo ""
          echo "âœ… Kubernetes connection test completed successfully!"
          echo ""
          echo "ğŸš€ You can now run deployments using the 'Deploy to Kubernetes' workflow" 